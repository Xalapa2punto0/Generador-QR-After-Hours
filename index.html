<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>QR con logo y borde cuadrado redondeado</title>
<style>
  body{
    font-family:sans-serif;
    background:#f5f5f5;
    padding:20px;
  }
  .card{
    background:#fff;
    padding:20px;
    max-width:500px;
    margin:auto;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.1);
  }
  #qr{
    display:flex;
    justify-content:center;
    margin:20px 0;
  }
  input,button{
    padding:10px;
    font-size:16px;
    margin:6px 0;
    width:100%;
  }
  button{
    background:#0b69ff;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
</style>
</head>
<body>
<div class="card">
  <h1>Generador de QR con logo y borde cuadrado redondeado</h1>
  <input id="text" type="text" placeholder="Texto o URL">
  <button id="gen">Generar QR</button>
  <div id="qr"></div>
  <button id="shareBtn" style="display:none;">Compartir QR</button>
</div>

<script src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
<script>
const genBtn = document.getElementById('gen');
const qrContainer = document.getElementById('qr');
const shareBtn = document.getElementById('shareBtn');
let qrCode;

// --- función que crea un logo con borde cuadrado y esquinas redondeadas ---
async function logoConBordeCuadrado(src, borde = 36, radioEsquinas = 16){
  return new Promise((resolve)=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function(){
      const s = Math.max(img.width, img.height) + borde*2;
      const c = document.createElement('canvas');
      c.width = c.height = s;
      const ctx = c.getContext('2d');

      // Borde negro cuadrado con esquinas redondeadas
      ctx.fillStyle = '#000';
      ctx.beginPath();
      dibujarRectRedondeado(ctx, 0, 0, s, s, radioEsquinas);
      ctx.fill();

      // Logo centrado con clip también cuadrado redondeado
      ctx.save();
      ctx.beginPath();
      dibujarRectRedondeado(ctx, borde, borde,
                            s - borde*2, s - borde*2, radioEsquinas);
      ctx.clip();
      ctx.drawImage(img, (s - img.width)/2, (s - img.height)/2);
      ctx.restore();

      resolve(c.toDataURL('image/png'));
    };
    img.src = src;
  });
}

// helper: dibuja un rectángulo de esquinas redondeadas
function dibujarRectRedondeado(ctx, x, y, w, h, r){
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
}

genBtn.addEventListener('click', async () => {
  const text = document.getElementById('text').value.trim();
  if(!text){ alert('Escribe un texto'); return; }

  qrContainer.innerHTML = '';

  // genera el logo con borde negro cuadrado y esquinas redondeadas
  const logoBordeado = await logoConBordeCuadrado('logo.png', 60, 20);

  qrCode = new QRCodeStyling({
    width: 300,
    height: 300,
    type: 'canvas',
    data: text,
    image: logoBordeado,
    imageOptions: { margin:0 },
    dotsOptions: { color:'#000', type:'rounded' },
    cornersSquareOptions: { type:'extra-rounded', color:'#000' },
    cornersDotOptions: { type:'dot', color:'#000' },
    backgroundOptions: { color:'#fff' }
  });

  qrCode.append(qrContainer);
  shareBtn.style.display = 'block';
});

shareBtn.addEventListener('click', async ()=>{
  if (!qrCode) return;
  const blob = await qrCode.getRawData('png');
  if (navigator.share &&
      navigator.canShare?.({ files: [new File([blob], 'qr.png', {type:'image/png'})] })) {
    const file = new File([blob], 'qr.png', { type: 'image/png' });
    navigator.share({
      files: [file],
      title: 'Código QR',
      text: 'Aquí está el código QR que generé'
    });
  } else {
    const text = 'Mira este código QR: (adjunta la imagen manualmente)';
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`,'_blank');
  }
});
</script>
</body>
</html>
